<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›»è…¦è¦–è¦º - æ¨¡æ“¬æ¸¬é©—</title>

    <!-- è®€ Excel ç”¨çš„ SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- æˆªåœ–ç”¨ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 800px;
            position: relative;
            overflow: hidden;
        }

        h1 {
            color: #2d3748;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2em;
        }

        h2 {
            color: #4a5568;
            text-align: center;
            margin-bottom: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            border-bottom: 2px solid #edf2f7;
            padding-bottom: 20px;
        }

        .header p {
            color: #718096;
            font-size: 1.1em;
        }

        .student-id-section {
            margin-bottom: 30px;
            text-align: left;
        }

        .student-id-section label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 600;
        }

        .student-id-section input[type="text"] {
            padding: 12px 20px;
            font-size: 1.1em;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            width: 100%;
            max-width: 400px;
            transition: all 0.3s ease;
            outline: none;
        }

        .student-id-section input[type="text"]:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .student-id-section select {
            padding: 10px 20px;
            font-size: 1em;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            outline: none;
            transition: all 0.3s ease;
        }

        .student-id-section select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 10px 0 0;
        }

        .radio-group label {
            cursor: pointer;
            padding: 10px 20px;
            background: #f7fafc;
            border: 2px solid #edf2f7;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .radio-group label:hover {
            background: #edf2f7;
        }

        .radio-group input[type="radio"] {
            display: none;
        }

        .radio-group input[type="radio"]:checked+span {
            color: #667eea;
            font-weight: bold;
        }

        .radio-group label:has(input:checked) {
            border-color: #667eea;
            background: #ebf4ff;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: block;
            margin: 30px auto 0;
            width: fit-content;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .error-message {
            color: #f44336;
            margin-top: 8px;
            display: none;
            font-size: 0.9em;
        }

        .quiz-screen {
            display: none;
        }

        .student-info {
            background: #ebf4ff;
            color: #4c51bf;
            padding: 10px 20px;
            border-radius: 50px;
            display: inline-block;
            margin-bottom: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #edf2f7;
            border-radius: 5px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .question-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            color: #666;
            font-weight: 500;
        }

        .question-text {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 30px;
            line-height: 1.6;
            font-weight: 500;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .option {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            padding: 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1em;
        }

        .option:hover {
            background: #e8f0fe;
            border-color: #667eea;
            transform: translateX(5px);
        }

        .option.correct {
            background: #4caf50;
            color: white;
            border-color: #4caf50;
        }

        .option.incorrect {
            background: #f44336;
            color: white;
            border-color: #f44336;
        }

        .option.disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1em;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .result-screen {
            display: none;
            text-align: center;
        }

        .result-header {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .result-header h3 {
            color: #667eea;
            font-size: 1.3em;
            margin-bottom: 10px;
        }

        .result-header p {
            color: #666;
            font-size: 1.1em;
            margin: 5px 0;
        }

        .score-display {
            font-size: 4em;
            font-weight: 700;
            margin: 30px 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .score-message {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 30px;
        }

        .result-details {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            text-align: left;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid #e0e0e0;
            font-size: 1.1em;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-item .label {
            color: #666;
            font-weight: 500;
        }

        .result-item .value {
            color: #333;
            font-weight: 700;
        }

        .hidden {
            display: none;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        .feedback {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-weight: 500;
            display: none;
        }

        .feedback.correct {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .feedback.incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        ul {
            color: #4a5568;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header fade-in">
            <h1>ğŸ“š é›»è…¦è¦–è¦º</h1>
            <p>æ¨¡æ“¬æ¸¬é©—</p>
        </div>

        <!-- é–‹å§‹ç•«é¢ -->
        <div class="start-screen fade-in" id="startScreen">
            <h2>æ­¡è¿åƒåŠ æ¨¡æ“¬æ¸¬é©—</h2>

            <!-- å­¸è™Ÿ -->
            <div class="student-id-section">
                <label for="studentId">å­¸è™Ÿ <span style="color: #f44336;">*</span></label>
                <input type="text" id="studentId" placeholder="è«‹è¼¸å…¥æ‚¨çš„å­¸è™Ÿ" maxlength="20">
                <div class="error-message" id="studentIdError">è«‹è¼¸å…¥å­¸è™Ÿ</div>
            </div>

            <!-- æ¸¬é©—æ¬¡æ•¸ -->
            <div class="student-id-section">
                <label>æ¸¬é©—æ¬¡æ•¸ <span style="color: #f44336;">*</span></label>
                <div class="radio-group">
                    <label><input type="radio" name="attempt" value="1" id="attempt1"><span>ç¬¬ä¸€æ¬¡æ¸¬é©—</span></label>
                    <label><input type="radio" name="attempt" value="2" id="attempt2"><span>ç¬¬äºŒæ¬¡æ¸¬é©—</span></label>
                </div>
                <div class="error-message" id="attemptError">è«‹é¸æ“‡æ¸¬é©—æ¬¡æ•¸</div>
            </div>

            <!-- ç« ç¯€é¸æ“‡ -->
            <div class="student-id-section">
                <label for="chapterSelect">é¸æ“‡ç« ç¯€ <span style="color: #f44336;">*</span></label>
                <select id="chapterSelect">
                    <option value="">è«‹é¸æ“‡ç« ç¯€</option>
                    <option value="1">Chapter 1</option>
                    <option value="2">Chapter 2</option>
                    <option value="3">Chapter 3</option>
                    <option value="4">Chapter 4</option>
                    <option value="5">Chapter 5</option>
                    <option value="6">Chapter 6</option>
                    <option value="7">Chapter 7</option>
                    <option value="8">Chapter 8</option>
                    <option value="9">Chapter 9</option>
                    <option value="10">Chapter 10</option>
                    <option value="11">Chapter 11</option>
                    <option value="12">Chapter 12</option>
                    <option value="13">Chapter 13</option>
                    <option value="14">Chapter 14</option>
                    <option value="15">Chapter 15</option>
                    <option value="16">Chapter 16</option>
                    <option value="17">Chapter 17</option>
                    <option value="18">Chapter 18</option>					
                </select>
                <div class="error-message" id="chapterError">è«‹é¸æ“‡ç« ç¯€</div>
                <div style="margin-top:8px; color:#4a5568; font-size:0.9em;" id="fileStatus">
                    å°šæœªè¼‰å…¥é¡Œåº«
                </div>
            </div>

            <ul>
                <li>æœ¬æ¸¬é©—æ¯æ¬¡å¾é¡Œåº«ä¸­éš¨æ©ŸæŠ½é¡Œ</li>
                <li>æœ€å¤šæŠ½å‡º 20 é¡Œé¸æ“‡é¡Œ</li>
                <li>æ¯é¡Œ 5 åˆ†ï¼Œç¸½åˆ†ä¾æœ¬æ¬¡é¡Œæ•¸è€Œå®š</li>
                <li>ç­”é¡Œå¾Œå¯ç«‹å³æŸ¥çœ‹æ­£ç¢ºç­”æ¡ˆ</li>
            </ul>

            <button class="btn" onclick="startQuiz()">é–‹å§‹æ¸¬é©—</button>
        </div>

        <!-- ä½œç­”ç•«é¢ -->
        <div class="quiz-screen" id="quizScreen">
            <div class="student-info" id="studentInfo"></div>

            <div class="progress-bar">
                <div class="progress-fill" id="progressBar"></div>
            </div>

            <div class="question-info">
                <span id="questionNumber">é¡Œç›® 1 / 20</span>
                <span id="score">å¾—åˆ†: 0 / 100</span>
            </div>

            <div class="question-text" id="questionText"></div>
            <div class="options" id="options"></div>
            <div class="feedback" id="feedback"></div>

            <div class="navigation">
                <button class="btn-secondary" onclick="previousQuestion()" id="prevBtn">ä¸Šä¸€é¡Œ</button>
                <button class="btn" onclick="nextQuestion()" id="nextBtn">ä¸‹ä¸€é¡Œ</button>
            </div>
        </div>

        <!-- çµæœç•«é¢ -->
        <div class="result-screen" id="resultScreen">
            <div class="result-header">
                <h3 id="resultChapter">æ¸¬é©—çµæœ</h3>
                <p id="resultStudentInfo"></p>
                <p id="resultAttempt"></p>
            </div>
            <h2>æ¸¬é©—å®Œæˆï¼</h2>
            <div class="score-display" id="finalScore">0</div>
            <div class="score-message" id="scoreMessage"></div>
            <div class="result-details">
                <div class="result-item">
                    <span class="label">ç¸½é¡Œæ•¸</span>
                    <span class="value" id="totalQuestions">0 é¡Œ</span>
                </div>
                <div class="result-item">
                    <span class="label">ç­”å°é¡Œæ•¸</span>
                    <span class="value" id="correctCount">0 é¡Œ</span>
                </div>
                <div class="result-item">
                    <span class="label">ç­”éŒ¯é¡Œæ•¸</span>
                    <span class="value" id="incorrectCount">0 é¡Œ</span>
                </div>
                <div class="result-item">
                    <span class="label">æ­£ç¢ºç‡</span>
                    <span class="value" id="accuracy">0%</span>
                </div>
            </div>
            <button class="btn" onclick="restartQuiz()">é‡æ–°æ¸¬é©—</button>
            <button class="btn btn-secondary" onclick="downloadResult()"
                style="margin-top: 10px; background: #28a745; border: none;">ğŸ“¸ ä¸‹è¼‰æˆç¸¾å–®</button>
        </div>
    </div>

    <script>
        // å¾ Excel ç¬¬ä¸€åˆ—è®€é€²ä¾†
        let QUIZ_TITLE = "";
        let CHAPTER_NAME = "";

        let allQuestions = [];        // é¡Œåº«ï¼ˆå…¨éƒ¨é¡Œç›®ï¼‰
        let quizQuestions = [];       // æœ¬æ¬¡æŠ½é¡Œ
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let score = 0;
        let studentId = '';
        let attemptNumber = '';
        let TOTAL_QUESTIONS = 20;     // ä¸€æ¬¡è€ƒå¹¾é¡Œï¼ˆæœ€å¤š 20 é¡Œï¼‰
        let loadedChapter = null;     // å·²è¼‰å…¥çš„ç« ç¯€ï¼ˆé¿å…é‡è¤‡è¼‰ï¼‰

        // è®€å–ç« ç¯€é¡Œåº«ï¼šchapter1.xlsx ~ chapter16.xlsx
        async function loadChapterQuestions(chapterNo) {
            // åŒä¸€ç« ç¯€å·²è¼‰å…¥éå°±ç›´æ¥ç”¨
            if (loadedChapter === chapterNo && allQuestions.length > 0) {
                return;
            }

            const filename = `chapter${chapterNo}.xlsx`;
            const fileStatus = document.getElementById('fileStatus');
            fileStatus.textContent = `è¼‰å…¥ä¸­ï¼š${filename} ...`;

            try {
                const res = await fetch(filename);
                if (!res.ok) {
                    throw new Error(`æ‰¾ä¸åˆ°æª”æ¡ˆï¼š${filename}`);
                }

                const arrayBuffer = await res.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];

                const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
                if (rows.length < 3) {
                    throw new Error('Excel å…§å®¹å¤ªå°‘');
                }

                // ç¬¬ä¸€åˆ—ï¼štitle / CHAPTER_NAME
                const metaRow = rows[0];   // [title, è³‡è¨Šå®‰å…¨æ¦‚è«–, CHAPTER_NAME, CH 01 è³‡è¨Šå®‰å…¨ç°¡ä»‹, ...]
                QUIZ_TITLE = metaRow[1] || "IPAS è³‡è¨Šå®‰å…¨å·¥ç¨‹å¸«";
                CHAPTER_NAME = metaRow[3] || `Chapter ${chapterNo}`;

                // ç¬¬äºŒåˆ—ï¼šæ¬„ä½åç¨±
                const header = rows[1];    // [question, options1, options2, options3, options4, answer]
                const dataRows = rows.slice(2); // ç¬¬ä¸‰åˆ—é–‹å§‹ï¼šé¡Œç›®è³‡æ–™

                const idx = (name) => header.indexOf(name);

                const colQuestion = idx('question');
                const colOpt1 = idx('options1');
                const colOpt2 = idx('options2');
                const colOpt3 = idx('options3');
                const colOpt4 = idx('options4');
                const colAnswer = idx('answer');

                if (colQuestion === -1 || colOpt1 === -1 || colAnswer === -1) {
                    throw new Error('ç¼ºå°‘å¿…è¦æ¬„ä½ï¼šquestion / options1 / answer');
                }

                allQuestions = [];

                dataRows.forEach(row => {
                    const qText = row[colQuestion];
                    if (!qText) return; // ç©ºåˆ—ç•¥é

                    const options = [];
                    if (colOpt1 !== -1 && row[colOpt1]) options.push(row[colOpt1]);
                    if (colOpt2 !== -1 && row[colOpt2]) options.push(row[colOpt2]);
                    if (colOpt3 !== -1 && row[colOpt3]) options.push(row[colOpt3]);
                    if (colOpt4 !== -1 && row[colOpt4]) options.push(row[colOpt4]);

                    const ansRaw = row[colAnswer];
                    const ansIndex = parseInt(ansRaw, 10) - 1;  // 1~4 è½‰ 0~3

                    if (isNaN(ansIndex) || ansIndex < 0 || ansIndex >= options.length) {
                        console.warn('ç­”æ¡ˆæ¬„æœ‰å•é¡Œï¼Œç•¥éæ­¤é¡Œï¼š', qText);
                        return;
                    }

                    allQuestions.push({
                        question: qText,
                        options: options,
                        answer: ansIndex
                    });
                });

                // æ›´æ–°ç•«é¢æ¨™é¡Œèˆ‡ç« ç¯€
                document.title = `${QUIZ_TITLE} - æ¨¡æ“¬æ¸¬é©—`;
                document.querySelector('.header h1').textContent = `ğŸ“š ${QUIZ_TITLE}`;
                document.querySelector('.header p').textContent = `${CHAPTER_NAME} - æ¨¡æ“¬æ¸¬é©—`;

                const rc = document.getElementById('resultChapter');
                if (rc) rc.textContent = CHAPTER_NAME;

                loadedChapter = chapterNo;
                fileStatus.textContent = `å·²è¼‰å…¥ ${allQuestions.length} é¡Œé¡Œç›®ï¼ˆ${filename}ï¼‰`;
                document.getElementById('chapterError').style.display = 'none';

            } catch (err) {
                console.error(err);
                fileStatus.textContent = 'è¼‰å…¥å¤±æ•—ï¼š' + err.message;
                allQuestions = [];
                loadedChapter = null;
                throw err; // è®“å¤–å±¤çŸ¥é“å¤±æ•—
            }
        }

        // é™£åˆ—æ´—ç‰Œ
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // é–‹å§‹æ¸¬é©—
        async function startQuiz() {
            const studentIdInput = document.getElementById('studentId');
            studentId = studentIdInput.value.trim();
            if (!studentId) {
                document.getElementById('studentIdError').style.display = 'block';
                studentIdInput.focus();
                return;
            }
            document.getElementById('studentIdError').style.display = 'none';

            const attempt1 = document.getElementById('attempt1');
            const attempt2 = document.getElementById('attempt2');
            if (!attempt1.checked && !attempt2.checked) {
                document.getElementById('attemptError').style.display = 'block';
                return;
            }
            document.getElementById('attemptError').style.display = 'none';
            attemptNumber = attempt1.checked ? '1' : '2';

            // ç« ç¯€é¸æ“‡
            const chapterSelect = document.getElementById('chapterSelect');
            const chapterValue = chapterSelect.value;
            if (!chapterValue) {
                document.getElementById('chapterError').style.display = 'block';
                return;
            }
            document.getElementById('chapterError').style.display = 'none';

            // è®€å–è©²ç« ç¯€é¡Œåº«
            try {
                await loadChapterQuestions(chapterValue);
            } catch (err) {
                alert('è¼‰å…¥é¡Œåº«å¤±æ•—ï¼š' + err.message);
                return;
            }

            if (!allQuestions || allQuestions.length === 0) {
                alert('æ­¤ç« ç¯€æ²’æœ‰å¯ç”¨é¡Œç›®');
                return;
            }

            // ä¸€æ¬¡æœ€å¤š 20 é¡Œï¼Œä¸å¤ å°±å…¨éƒ¨å‡º
            TOTAL_QUESTIONS = Math.min(20, allQuestions.length);

            quizQuestions = shuffleArray(allQuestions).slice(0, TOTAL_QUESTIONS);
            currentQuestionIndex = 0;
            userAnswers = new Array(TOTAL_QUESTIONS).fill(null);
            score = 0;

            document.getElementById('studentInfo').textContent =
                `å­¸è™Ÿ: ${studentId} | ç¬¬${attemptNumber}æ¬¡æ¸¬é©— | ${CHAPTER_NAME}`;

            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('quizScreen').style.display = 'block';
            document.getElementById('resultScreen').style.display = 'none';

            displayQuestion();
        }

        // é¡Œç›®é¡¯ç¤º
        function displayQuestion() {
            const question = quizQuestions[currentQuestionIndex];
            document.getElementById('questionNumber').textContent =
                `é¡Œç›® ${currentQuestionIndex + 1} / ${TOTAL_QUESTIONS}`;
            document.getElementById('questionText').textContent = question.question;

            const optionsContainer = document.getElementById('options');
            optionsContainer.innerHTML = '';

            question.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option';
                optionDiv.textContent = `${String.fromCharCode(65 + index)}) ${option}`;
                optionDiv.onclick = () => selectOption(index);

                if (userAnswers[currentQuestionIndex] !== null) {
                    optionDiv.classList.add('disabled');

                    if (index === userAnswers[currentQuestionIndex]) {
                        optionDiv.classList.add(
                            index === question.answer ? 'correct' : 'incorrect'
                        );
                    }
                    if (index === question.answer) {
                        optionDiv.classList.add('correct');
                    }
                }

                optionsContainer.appendChild(optionDiv);
            });

            const feedback = document.getElementById('feedback');
            if (userAnswers[currentQuestionIndex] !== null) {
                const isCorrect =
                    userAnswers[currentQuestionIndex] === question.answer;
                feedback.className = 'feedback ' + (isCorrect ? 'correct' : 'incorrect');
                feedback.textContent = isCorrect
                    ? 'âœ“ ç­”å°äº†ï¼'
                    : `âœ— ç­”éŒ¯äº†ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯ ${String.fromCharCode(65 + question.answer)}) ${question.options[question.answer]}`;
                feedback.style.display = 'block';
            } else {
                feedback.style.display = 'none';
            }

            const progress = ((currentQuestionIndex + 1) / TOTAL_QUESTIONS) * 100;
            document.getElementById('progressBar').style.width = progress + '%';

            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            document.getElementById('nextBtn').textContent =
                currentQuestionIndex === TOTAL_QUESTIONS - 1 ? 'æŸ¥çœ‹æˆç¸¾' : 'ä¸‹ä¸€é¡Œ';

            updateScore();
        }

        // é¸æ“‡ç­”æ¡ˆ
        function selectOption(optionIndex) {
            if (userAnswers[currentQuestionIndex] !== null) return;

            const question = quizQuestions[currentQuestionIndex];
            userAnswers[currentQuestionIndex] = optionIndex;

            if (optionIndex === question.answer) {
                score += 5;
            }

            displayQuestion();
        }

        // æ›´æ–°å¾—åˆ†ï¼ˆç¸½åˆ† = é¡Œæ•¸ * 5ï¼‰
        function updateScore() {
            const maxScore = TOTAL_QUESTIONS * 5;
            document.getElementById('score').textContent = `å¾—åˆ†: ${score} / ${maxScore}`;
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion();
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < TOTAL_QUESTIONS - 1) {
                currentQuestionIndex++;
                displayQuestion();
            } else {
                showResults();
            }
        }

        // é¡¯ç¤ºçµæœ
        function showResults() {
            document.getElementById('quizScreen').style.display = 'none';
            document.getElementById('resultScreen').style.display = 'block';

            const maxScore = TOTAL_QUESTIONS * 5;

            document.getElementById('resultChapter').textContent =
                CHAPTER_NAME || 'æ¸¬é©—çµæœ';
            document.getElementById('resultStudentInfo').textContent = `å­¸è™Ÿ: ${studentId}`;
            document.getElementById('resultAttempt').textContent =
                `ç¬¬${attemptNumber}æ¬¡æ¸¬é©—`;

            const correctCount = userAnswers.filter(
                (answer, index) => answer === quizQuestions[index].answer
            ).length;
            const incorrectCount = TOTAL_QUESTIONS - correctCount;
            const accuracy = (correctCount / TOTAL_QUESTIONS * 100).toFixed(1);
            const percent = (score / maxScore * 100).toFixed(1);

            document.getElementById('finalScore').textContent = `${score} åˆ†`;
            document.getElementById('correctCount').textContent = `${correctCount} é¡Œ`;
            document.getElementById('incorrectCount').textContent = `${incorrectCount} é¡Œ`;
            document.getElementById('accuracy').textContent = `${accuracy}%`;
            document.getElementById('totalQuestions').textContent = `${TOTAL_QUESTIONS} é¡Œ`;

            let message = '';
            const p = parseFloat(percent);
            if (p >= 90) message = 'ğŸ‰ å„ªç§€ï¼æ‚¨å°è³‡è¨Šå®‰å…¨æœ‰æ·±å…¥çš„äº†è§£ï¼';
            else if (p >= 80) message = 'ğŸ‘ å¾ˆå¥½ï¼ç¹¼çºŒä¿æŒï¼';
            else if (p >= 70) message = 'âœ“ ä¸éŒ¯ï¼é‚„æœ‰é€²æ­¥ç©ºé–“ï¼';
            else if (p >= 60) message = 'ğŸ“– åŠæ ¼ï¼å»ºè­°å¤šåŠ è¤‡ç¿’ï¼';
            else message = 'ğŸ’ª åŠ æ²¹ï¼å»ºè­°é‡æ–°å­¸ç¿’ç›¸é—œå…§å®¹ï¼';
            document.getElementById('scoreMessage').textContent = message;
        }

        // é‡æ–°æ¸¬é©—ï¼ˆå›åˆ°é–‹å§‹ç•«é¢ï¼‰
        function restartQuiz() {
            document.getElementById('resultScreen').style.display = 'none';
            document.getElementById('startScreen').style.display = 'block';
            document.getElementById('studentId').value = '';
            document.getElementById('attempt1').checked = false;
            document.getElementById('attempt2').checked = false;
            // ä¿ç•™å·²è¼‰å…¥çš„é¡Œåº«ï¼Œä¸æ¸…ç©º allQuestionsï¼Œè®“åŒä¸€ç« ç¯€ä¸ç”¨å†è¼‰
        }

        // æˆç¸¾æˆªåœ–ä¸‹è¼‰
        function downloadResult() {
            if (typeof html2canvas === 'undefined') {
                alert('ç„¡æ³•è¼‰å…¥æˆªåœ–å…ƒä»¶ï¼Œè«‹ç¢ºèªæ‚¨çš„ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸ (éœ€é€£ç·šè‡³ cdnjs.cloudflare.com)ã€‚\nå¦‚æœç„¡æ³•é€£ç·šï¼Œè«‹ç›´æ¥ä½¿ç”¨é›»è…¦çš„æˆªåœ–åŠŸèƒ½ (PrintScreen æˆ– å‰ªå–å·¥å…·) ä¿å­˜æˆç¸¾ã€‚');
                return;
            }

            const resultScreen = document.getElementById('resultScreen');
            const btn = document.querySelector('.btn.btn-secondary[onclick="downloadResult()"]');
            const originalText = btn.textContent;
            btn.textContent = 'è™•ç†ä¸­...';
            btn.disabled = true;

            try {
                html2canvas(resultScreen, {
                    scale: 2, // æå‡ç•«è³ª
                    useCORS: true,
                    logging: false
                }).then(canvas => {
                    const safeStudentId = (studentId || 'Guest').replace(/[^a-z0-9]/gi, '_').substring(0, 20);
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                    const filename = `IPAS_Result_${safeStudentId}_${timestamp}.png`;

                    if (canvas.width === 0 || canvas.height === 0) {
                        throw new Error('æˆªåœ–å…§å®¹ç‚ºç©º');
                    }

                    const link = document.createElement('a');
                    link.download = filename;
                    link.href = canvas.toDataURL('image/png');
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    btn.textContent = 'ä¸‹è¼‰å®Œæˆ';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.disabled = false;
                    }, 2000);
                }).catch(err => {
                    console.error('Screenshot failed:', err);
                    alert('æˆªåœ–å¤±æ•—ï¼Œè«‹æ‰‹å‹•æˆªåœ–ã€‚éŒ¯èª¤: ' + err.message);
                    btn.textContent = originalText;
                    btn.disabled = false;
                });
            } catch (e) {
                console.error('Screenshot error:', e);
                alert('æˆªåœ–ç™¼ç”ŸéŒ¯èª¤: ' + e.message);
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>

</html>
